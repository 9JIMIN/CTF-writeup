# 포트포워딩

```php
$port = rand(10000,10100); // 10000 ~ 10100 사이의 포트번호를 생성
$socket = fsockopen($_GET['server'],$port,$errno,$errstr,3) or die("error : {$errstr}"); // 해당 포트 연결, 안되면 에러

Warning: fsockopen(): unable to connect to 39.112.202.229:10023 (Connection timed out) in /var/www/html/challenge/web-16/index.php on line 23
error : Connection timed out
```

`10000 ~ 10100` 범위의 포트들 중에서 하나의 포트로 외부에서 접속을 시도하고 있다. 
공유기에 연결된 공인 IP가 `39.112.202.229`이니까, 랜덤 포트를 받아서, 접속요청은 `39.112.202.229:10001` 이렇게 오게 된다.

저 포트로 오는 요청은 내 디바이스에서 알 수가 없기에, 포트포워딩으로 해당 포트의 요청을 내 디바이스의 특정 포트로 연결시켜줘야 한다. 
이걸 포트포워딩이라고 한다. 

> 공유기 외부에서 공유기 내부의 컴퓨터에 접속하기 위해서 공유기의 몇번 포트에 접속한 정보를 (공인IP주소:포트번호)
> 공유기 내의 특정 디바이스(로컬IP주소:포트번호) 연결해줄 것인지를 공유기에게 알려주는 것.

내 디바이스로 해당 접속요청을 넘겨 받아야하기에, 
공유기 설정 => 포트포워딩설정을 해줘야 한다. 

설정 내용은 외부 포트 `10000~10100`을 내부IP주소(내 디바이스 주소) + 내부포트(10000) 으로 포트포워딩한다. 
그리고 해당 포트로 오는 요청을 들어야 하기에 netcat을 이용하여 10000포트를 열어준다.

```
$ nc -l -p 10000
-l: listen모드
-p: 로컬 포트 지정
즉, -l -p 10000 은 '로컬 포트 10000을 리슨모드로 열어라' 는 명령어이다.
```

그리고, 사이트를 새로고침에서 다시 요청이 오게되면, 
외부IP주소 10000~10100 포트로 보낸 내용이 내 디바이스 10000포트로 오면서 
저렇게 내용을 볼 수 있다.

```shell
jimin@fossa:~$ nc -l -p 10000 
GET /FLAG{i_have_a_big_and_beautiful_server} HTTP/1.0
Host: 39.112.202.229
```